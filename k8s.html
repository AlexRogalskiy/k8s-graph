<!DOCTYPE html>
<html>
<head>
    <title>k8s graph - By Ralf Strobel</title>
</head>
<meta charset="utf-8">
<style type="text/css">
    html, body {
        height: 100%;
        margin: 0;
    }

</style>

<body>
<svg id="wrapper" width="100%" height="100%"></svg>
<script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
<script>
    "use strict";

    var go = true,
        svg = d3.select("svg"),
        width = 800,
        height = 800,
        color = d3.scaleOrdinal(d3.schemeCategory10),
        nodes = [],
        links = [];

    var simulation = d3.forceSimulation()
        .force("charge", d3.forceManyBody().strength(-1000))
        .force("collide",d3.forceCollide(function(d) {return d.size * 1.3 }).iterations(2) )
        .force("link", d3.forceLink(links).id(function(d) {return d.id;}).distance(function(d) {return d.length / 6;}))
        .force("x", d3.forceX())
        .force("y", d3.forceY())
        .alphaTarget(.01)
        .on("tick", ticked);

    svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all")
        .call(d3.zoom()
            .on("zoom", zoomed));
    var g = svg.append("g"),
        link = g.append("g").attr("class", "link").attr("stroke", "#000").selectAll(".link"),
        node = g.append("g").attr("class", "node").attr("stroke", "#000").selectAll(".node"),
        text = g.append("g").attr("class", "text").selectAll(".text");
    restart();

    function restart() {
        // Nodes
        node = node.data(nodes, function(d) { return d.id;});
        node.exit().remove();
        node = node.enter()
            .append("path")
            .attr("d", d3.symbol()
                .size(function(d) {return d.size*100})
                .type(function(d) {
                    if (d.type === "node") {
                        return d3.symbolSquare;
                    } else if (d.type === "master") {
                        return d3.symbolStar;
                    } else {
                        return d3.symbolCircle;
                    }
                }))
            .attr("fill", function(d) { return color(d.color); })
            .attr("class", "node")
            .attr("stroke-width", function(d) {return d.size * 0.15})
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .merge(node);
        // Links
        link = link.data(links);
        link.exit().remove();
        link = link.enter()
            .append("line")
            .attr("class", "line")
            .attr("stroke-width", 2)
            .merge(link);
        // Text
        text = text.data(nodes);
        text.exit().remove();
        text = text.enter()
            .append("text")
            .attr("class", "text")
            .attr("font-size", function(d) {return d.size})
            .text(function(d) {return d.text})
            .merge(text);

        // Update and restart the simulation.
        simulation.nodes(nodes);
        simulation.force("link").links(links);
    }

    function ticked() {
        svg.selectAll("path")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        text.attr("x", function(d) { return d.x + d.size * 1.2; })
            .attr("y", function(d) { return d.y; })
            .attr("dy", "0.35em");
        //simulation.restart();

    }
    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
    }
    function zoomed() {
        g.attr("transform", d3.event.transform);
    }
</script>
<script src="/socket.io/socket.io.js"></script>
<script>
    let socket = io();
    socket.on('update', function(msg) {
        function updatesNodes(nodesFromServer) {
            // Delete
            let i = 0;
            nodes.forEach(node => {
                if (nodesFromServer.find(item => item.id === node.id) === undefined) {
                    nodes.splice(i, 1);
                    simulation.alpha(.01).restart();
                }
                i++;
            });

            // Insert
            nodesFromServer.forEach(node => {
                if (nodes.find(item => item.id === node.id) === undefined) {
                    nodes.push(node);
                }
            });
        }

        function updatesLinks(linksFromServer) {
            let i = 0;
            // Delete
            links.forEach(link => {
                if (linksFromServer.find(item => item.source === link.source.id && item.target === link.target.id) === undefined) {
                    links.splice(i, 1);
                    simulation.alpha(.01).restart();
                }
                i++;
            });

            // Insert
            linksFromServer.forEach(link => {
                if (links.find(item => item.source.id === link.source && item.target.id === link.target) === undefined) {
                    links.push(link);
                }
            });
        }

        if (go) {
            updatesNodes(msg.nodes);
            updatesLinks(msg.links);
            restart();
        }
    });
    socket.on('error', function(error) {
        console.error("Error from server: " + error);
    });
</script>
</body>
</html>